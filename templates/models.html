{% extends "layout.html" %}
{% block content %}
  <section class="panel modelsPage">
    <div class="panel__title">AI模型管理</div>
    <div class="panel__body">
      <div class="grid grid--2 modelsGrid">
        <div class="card">
          <div class="card__title">新增 / 更新模型配置</div>
          <form class="form" method="post" action="{{ url_for('models_upsert') }}">
            <input type="hidden" name="id" value="" />
            <label class="field">
              <span class="field__label">名称</span>
              <input class="input" name="name" placeholder="默认模型" />
            </label>
            <label class="field">
              <span class="field__label">Base URL</span>
              <input class="input" name="base_url" placeholder="https://api.openai.com/v1" />
            </label>
            <label class="field">
              <span class="field__label">API Key</span>
              <input class="input" name="api_key" placeholder="sk-..." />
            </label>
            <label class="field">
              <span class="field__label">Model</span>
              <input class="input" name="model" placeholder="gpt-4o-mini" />
            </label>
            <label class="field">
              <span class="field__label">系统提示词</span>
              <textarea class="textarea" name="system_prompt" rows="5" placeholder="你是政企舆情分析助手。"></textarea>
            </label>
            <label class="switch">
              <input type="checkbox" name="enabled" />
              <span class="switch__text">启用</span>
            </label>
            <button class="btn btn--primary" type="submit">保存</button>
          </form>
        </div>

        <div class="card">
          <div class="card__title">模型列表</div>
          <div class="card__meta">累计Token：{{ total_tokens }}</div>
          <div class="table table--compact">
            <div class="table__row table__row--head">
              <div>名称</div>
              <div>Model</div>
              <div>状态</div>
              <div class="table__headActions">操作</div>
            </div>
            {% for c in configs %}
              <div class="table__row">
                <div>{{ c.name }}</div>
                <div class="muted">{{ c.model }}</div>
                <div>
                  {% if c.enabled %}
                    <span class="badge badge--ok">启用</span>
                  {% else %}
                    <span class="badge badge--muted">停用</span>
                  {% endif %}
                </div>
                <div class="table__actions">
                  <button class="btn btn--ghost btn--sm" data-action="openTest" data-config-id="{{ c.id }}">对话测试</button>
                  <form method="post" action="{{ url_for('models_toggle', config_id=c.id) }}">
                    <button class="btn btn--ghost btn--sm" type="submit">{{ "停用" if c.enabled else "启用" }}</button>
                  </form>
                  <form method="post" action="{{ url_for('models_delete', config_id=c.id) }}" onsubmit="return confirm('确认删除该模型？');">
                    <button class="btn btn--danger btn--sm" type="submit">删除</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="modal" class="modal hidden">
    <div class="modal__mask" onclick="closeModal()"></div>
    <div class="modal__panel">
      <div class="modal__title">模型测试</div>
      <div class="chat">
        <div id="chatLog" class="chat__log"></div>
        <div class="chat__input">
          <input id="chatText" class="input" placeholder="输入消息…" />
          <button class="btn btn--primary" onclick="sendMsg()">发送</button>
        </div>
      </div>
      <div class="modal__footer">
        <button class="btn btn--ghost" onclick="closeModal()">关闭</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    let curConfigId = null;
    const modal = document.getElementById('modal');
    const chatLog = document.getElementById('chatLog');
    const chatText = document.getElementById('chatText');

    function openTest(id) {
      curConfigId = id;
      modal.classList.remove('hidden');
      chatLog.innerHTML = '';
      chatText.value = '你好';
      chatText.focus();
    }
    function closeModal() {
      modal.classList.add('hidden');
      curConfigId = null;
    }
    function addLine(role, text) {
      const el = document.createElement('div');
      el.className = 'chat__line chat__line--' + role;
      el.textContent = text;
      chatLog.appendChild(el);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    async function sendMsg() {
      const msg = (chatText.value || '').trim();
      if (!msg) return;
      addLine('user', msg);
      chatText.value = '';
      const r = await fetch('{{ url_for("api_models_test") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config_id: curConfigId, message: msg })
      });
      const d = await r.json();
      if (!d.ok) { addLine('bot', d.error || '请求失败'); return; }
      addLine('bot', d.reply || '');
    }
    chatText.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMsg();
    });
    Array.from(document.querySelectorAll('[data-action="openTest"]')).forEach((btn) => {
      btn.addEventListener('click', () => openTest(Number(btn.dataset.configId)));
    });
  </script>
{% endblock %}
